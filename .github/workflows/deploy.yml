name: D√©ploiement du NOX-MINI-BOT2 sur VPS

on:
  push:
    branches:
      - main # Le d√©ploiement s'ex√©cute uniquement lors d'un push sur la branche main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production # Optionnel, mais bonne pratique pour un d√©ploiement

    steps:
      - name: ‚¨áÔ∏è Checkout du Code
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Ajustez cette version si n√©cessaire

      - name: üöÄ D√©ploiement et Red√©marrage via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          # Les secrets sont d√©finis dans les param√®tres de votre d√©p√¥t GitHub
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # D√©finissez le chemin o√π votre application est install√©e sur le VPS
            APP_DIR="/var/www/nox-mini-bot2" # REMPLACEZ PAR VOTRE CHEMIN R√âEL
            
            echo "1. Navigation vers le r√©pertoire de l'application..."
            mkdir -p $APP_DIR # Cr√©e le dossier s'il n'existe pas
            cd $APP_DIR
            
            # Gestion du d√©p√¥t : clonage si inexistant, sinon pull
            if [ ! -d "node_modules" ]; then
              echo "2. D√©p√¥t non clon√©. Clonage initial..."
              # Utilisez l'URL SSH pour le clonage s√©curis√©
              git clone git@github.com:GaaraTechx/NOX-MINI-BOT2.git .
            else
              echo "2. D√©p√¥t existant. Mise √† jour (git pull)..."
              git pull origin main
            fi
            
            # 3. Installation des d√©pendances et build
            echo "3. Installation des d√©pendances..."
            npm install --production # Installe uniquement les d√©pendances de production
            
            # (Optionnel) Si vous avez une √©tape de build, d√©commentez ceci :
            # echo "3b. Ex√©cution du build..."
            # npm run build
            
            # 4. Red√©marrage de l'application avec PM2
            echo "4. Red√©marrage de l'application avec PM2..."
            # 'NOX-MINI-BOT2-App' est le nom que PM2 utilisera
            pm2 restart NOX-MINI-BOT2-App || pm2 start npm --name "NOX-MINI-BOT2-App" -- start
            
            echo "‚úÖ D√©ploiement termin√© avec succ√®s."
